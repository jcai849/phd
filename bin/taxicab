#!/bin/sh

NCSV=7
NHOST=8
MAXLINE=2500000
CHUNKMAX=32
mkdir -p /space/taxicab
cd /space/taxicab
curl "https://s3.amazonaws.com/nyc-tlc/trip+data/yellow_tripdata_2010-[01-07].csv" -o "taxicab-#1.csv"
find -name 'taxicab-*' -exec sed '1,2d' {} \; |
	split -l $MAXLINE
NCHUNK=`find -name '*' -printf '.' | wc -c`
CHUNKS=`test $NCHUNK \< $CHUNKMAX && printf '%d'  $NCHUNK || printf '%d' $CHUNKMAX`
CHUNKSPERHOST=`expr $CHUNKS / $NHOST`
awk "BEGIN { for(i=0;i<$NHOST;i++) {
			for(j=0;j<$CHUNKSPERHOST;j++) {
				printf \"scp x%c%c hadoop%d:taxicab-%02d.csv\n\0\",
				97+((j+(i*$CHUNKSPERHOST))/26),
				97+((j+(i*$CHUNKSPERHOST))%26), 
				i+1,
				j+(i*$CHUNKSPERHOST)
			}
		}
	}" |
	xargs -P0 -I % sh -c {}

#doall find -name taxicab\\* -maxdepth 1 -delete
